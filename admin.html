<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم أنور الراجح للديكور</title>
    
    <!-- Cairo Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Inline CSS for Admin Panel -->
    <style>
        :root {
            --primary-blue: #1976D2;
            --primary-light: #2196F3;
            --accent-gold: #D4AF37;
            --neutral-dark: #2C3E50;
            --neutral-white: #FFFFFF;
            --neutral-light: #E9ECEF;
            --border-radius: 8px;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: var(--neutral-light); color: var(--neutral-dark); direction: rtl; text-align: right; min-height: 100vh; display: flex; }

        .btn {
            background: var(--primary-blue);
            color: var(--neutral-white);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-gold {
            background: var(--accent-gold);
            color: var(--neutral-dark);
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 250px;
            background: var(--neutral-dark);
            color: var(--neutral-white);
            padding: 2rem 1rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .sidebar h2 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 2rem;
            color: var(--accent-gold);
        }

        .sidebar nav a {
            display: block;
            color: var(--neutral-white);
            text-decoration: none;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            transition: background 0.3s ease;
        }

        .sidebar nav a:hover, .sidebar nav a.active {
            background: var(--primary-blue);
        }
        
        .sidebar button {
            width: 100%;
            margin-top: 2rem;
        }

        /* Main Content */
        .main-panel {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .card {
            background: var(--neutral-white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .card h3 {
            color: var(--primary-blue);
            border-bottom: 2px solid var(--accent-gold);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input[type="text"], input[type="email"], input[type="password"], input[type="number"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--neutral-light);
            border-radius: var(--border-radius);
            font-size: 1rem;
            text-align: right;
        }

        .login-container {
            max-width: 400px;
            margin: 10vh auto;
            padding: 3rem;
            background: var(--neutral-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .project-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px dashed var(--neutral-light);
        }
        
        .project-list-item:last-child {
            border-bottom: none;
        }

        .project-actions button {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>

    <!-- Admin Panel Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, query, setLogLevel, addDoc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // User-provided Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAJjD-ShtdoCr_waoB2NSBAn4O_znE8sV8",
            authDomain: "anawer-eec45.firebaseapp.com",
            projectId: "anawer-eec45",
            storageBucket: "anawer-eec45.firebasestorage.app",
            messagingSenderId: "1058097078828",
            appId: "1:1058097078828:web:757b48bdd1984953c1a789",
            measurementId: "G-XWS7ESFP6K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Use the Canvas-provided App ID for public data path
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const PROJECTS_COLLECTION = `artifacts/${appId}/public/data/projects`;
        const SETTINGS_DOC = `artifacts/${appId}/public/data/settings/site_settings`;

        let currentAdminUser = null;
        let siteSettings = {};
        let projectsData = [];

        // --- UI ELEMENTS ---
        const appContainer = document.body;
        
        // --- AUTHENTICATION ---
        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            setLoading(true);

            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    alertUser('تم تسجيل الدخول بنجاح.', 'success');
                })
                .catch(error => {
                    console.error('Login Error:', error);
                    alertUser('خطأ في تسجيل الدخول. تأكد من البريد وكلمة المرور.', 'error');
                })
                .finally(() => setLoading(false));
        }

        function handleLogout() {
            signOut(auth).then(() => {
                alertUser('تم تسجيل الخروج بنجاح.', 'success');
            }).catch(error => {
                console.error('Logout Error:', error);
            });
        }
        
        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            currentAdminUser = user;
            if (user) {
                // Render Admin Panel and expose functions before starting data fetch
                renderAdminPanel();
                fetchProjectsRealtime();
                fetchSettings();
            } else {
                renderLoginPage();
            }
        });
        
        // --- DATA FETCHING ---
        function fetchSettings() {
             onSnapshot(doc(db, SETTINGS_DOC), (docSnap) => {
                if (docSnap.exists()) {
                    siteSettings = docSnap.data();
                } else {
                    siteSettings = { pricePerMeter: 23000, heroImageUrl: '' };
                }
                // Only render if we are on the settings page or dashboard
                const currentView = document.querySelector('.sidebar nav a.active')?.getAttribute('data-page');
                if (currentView === 'settings') {
                    renderSettingsPage();
                } else if (currentView === 'dashboard') {
                    // Update dashboard fields
                    const lastUpdatedSpan = document.getElementById('last-updated-setting');
                    if(lastUpdatedSpan) {
                         lastUpdatedSpan.textContent = siteSettings.lastUpdated ? new Date(siteSettings.lastUpdated).toLocaleString() : '---';
                    }
                }
            }, (error) => {
                console.error("Error fetching settings:", error);
                alertUser("فشل تحميل إعدادات الموقع.", "error");
            });
        }

        function fetchProjectsRealtime() {
            onSnapshot(collection(db, PROJECTS_COLLECTION), (snapshot) => {
                projectsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Only render if we are on the projects page
                const currentView = document.querySelector('.sidebar nav a.active')?.getAttribute('data-page');
                if (currentView === 'projects-management') {
                    renderProjectsPage();
                }
                
                // Update dashboard project count
                const totalProjectsSpan = document.getElementById('total-projects');
                if(totalProjectsSpan) totalProjectsSpan.textContent = projectsData.length;
                
            }, (error) => {
                console.error("Error fetching projects:", error);
                alertUser("فشل تحميل قائمة المشاريع.", "error");
            });
        }

        // --- DATA MANAGEMENT ---
        async function saveSettings() {
            setLoading(true);
            const price = parseFloat(document.getElementById('setting-price').value);
            const imageUrl = document.getElementById('setting-hero-url').value;
            
            if (isNaN(price) || price <= 0) {
                alertUser('الرجاء إدخال سعر صحيح.', 'error');
                setLoading(false);
                return;
            }

            try {
                await setDoc(doc(db, SETTINGS_DOC), {
                    pricePerMeter: price,
                    heroImageUrl: imageUrl,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
                alertUser('تم حفظ الإعدادات بنجاح.', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                alertUser('خطأ في حفظ الإعدادات.', 'error');
            } finally {
                setLoading(false);
            }
        }
        
        async function uploadHeroImage(file) {
            if (!file) {
                alertUser('الرجاء اختيار ملف صورة أولاً.', 'error');
                return;
            }
            setLoading(true);
            try {
                const storageRef = ref(storage, `site_assets/hero_image/${file.name}`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                document.getElementById('setting-hero-url').value = downloadURL;
                
                // Update preview image immediately
                const heroPreview = document.getElementById('hero-preview');
                if (heroPreview) heroPreview.src = downloadURL;
                
                alertUser('تم رفع الصورة بنجاح. اضغط حفظ الإعدادات لتطبيقها.', 'success');
            } catch (error) {
                console.error('Error uploading image:', error);
                alertUser('فشل في رفع الصورة.', 'error');
            } finally {
                setLoading(false);
            }
        }

        async function addProject() {
            const title = document.getElementById('project-title').value;
            const category = document.getElementById('project-category').value;
            const description = document.getElementById('project-description').value;
            const imageFile = document.getElementById('project-image').files[0];

            if (!title || !category || !imageFile) {
                alertUser('الرجاء ملء حقول العنوان والفئة واختيار صورة.', 'error');
                return;
            }

            setLoading(true);
            try {
                // 1. Upload Image to Storage
                const storageRef = ref(storage, `projects/${category}/${Date.now()}_${imageFile.name}`);
                await uploadBytes(storageRef, imageFile);
                const imageUrl = await getDownloadURL(storageRef);

                // 2. Add Project Document to Firestore
                await addDoc(collection(db, PROJECTS_COLLECTION), {
                    title,
                    category,
                    description: description || '',
                    image: imageUrl,
                    createdAt: new Date().toISOString()
                });

                alertUser('تم إضافة المشروع بنجاح.', 'success');
                document.getElementById('project-form').reset();
            } catch (error) {
                console.error('Error adding project:', error);
                alertUser('فشل في إضافة المشروع.', 'error');
            } finally {
                setLoading(false);
            }
        }

        async function deleteProject(projectId) {
            // Replaced confirm() with alertUser style for better experience
            if (!window.confirm('هل أنت متأكد من حذف هذا المشروع؟ سيتم حذفه نهائياً.')) return;
            
            setLoading(true);
            try {
                // Note: Deleting the image from storage is complex and error-prone in a single-file demo, 
                // so we only delete the document. In a real app, storage deletion is mandatory.
                await deleteDoc(doc(db, PROJECTS_COLLECTION, projectId));
                alertUser('تم حذف المشروع بنجاح.', 'success');
            } catch (error) {
                console.error('Error deleting project:', error);
                alertUser('فشل في حذف المشروع.', 'error');
            } finally {
                setLoading(false);
            }
        }
        
        // --- UI RENDERING ---
        
        function navigateAdmin(pageId) {
            const sections = document.querySelectorAll('.page-section');
            sections.forEach(sec => sec.style.display = 'none');
            
            const activeSection = document.getElementById(pageId);
            if (activeSection) {
                activeSection.style.display = 'block';
            }
            
            const navLinks = document.querySelectorAll('.sidebar nav a');
            navLinks.forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar nav a[data-page="${pageId}"]`);
            if (activeLink) activeLink.classList.add('active');
            
            // Re-render data dependent pages when navigating to them
            if (pageId === 'settings') {
                renderSettingsPage();
            } else if (pageId === 'projects-management') {
                renderProjectsPage();
            } else if (pageId === 'dashboard') {
                // Ensure dashboard data is updated
                const lastUpdatedSpan = document.getElementById('last-updated-setting');
                if(lastUpdatedSpan) {
                     lastUpdatedSpan.textContent = siteSettings.lastUpdated ? new Date(siteSettings.lastUpdated).toLocaleString() : '---';
                }
            }
        }

        function renderLoginPage() {
            appContainer.innerHTML = `
                <div class="main-panel" style="width: 100%;">
                    <div class="login-container">
                        <h3 style="text-align: center; color: var(--accent-gold);">تسجيل الدخول كمسؤول</h3>
                        <div class="form-group">
                            <label for="login-email">البريد الإلكتروني</label>
                            <input type="email" id="login-email" placeholder="admin@example.com">
                        </div>
                        <div class="form-group">
                            <label for="login-password">كلمة المرور</label>
                            <input type="password" id="login-password" placeholder="كلمة المرور">
                        </div>
                        <button class="btn" style="width: 100%;" onclick="handleLogin()">تسجيل الدخول</button>
                    </div>
                </div>
            `;
            // Expose login function to be accessible from the rendered HTML
            window.handleLogin = handleLogin;
            setLoading(false);
        }

        function renderAdminPanel() {
            appContainer.innerHTML = `
                <div class="sidebar">
                    <h2>لوحة التحكم</h2>
                    <nav>
                        <a href="#" data-page="dashboard" onclick="navigateAdmin('dashboard')">الرئيسية</a>
                        <a href="#" data-page="settings" onclick="navigateAdmin('settings')">إعدادات الموقع</a>
                        <a href="#" data-page="projects-management" onclick="navigateAdmin('projects-management')">إدارة المشاريع</a>
                    </nav>
                    <button class="btn btn-gold" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt" style="margin-left: 0.5rem;"></i> تسجيل الخروج
                    </button>
                    <p style="font-size: 0.75rem; color: #aaa; margin-top: 1rem;">Admin ID: ${currentAdminUser.uid.substring(0, 10)}...</p>
                </div>
                
                <div class="main-panel" id="admin-main-panel">
                    <div id="dashboard" class="page-section card">
                        <h3>ملخص لوحة التحكم</h3>
                        <p>أهلاً بك يا ${currentAdminUser.email} في لوحة التحكم. يمكنك إدارة محتوى موقعك من القائمة الجانبية.</p>
                        <p><strong>آخر تحديث للأسعار:</strong> <span id="last-updated-setting">---</span></p>
                        <p><strong>عدد المشاريع الحالية:</strong> <span id="total-projects">${projectsData.length}</span></p>
                    </div>
                    
                    <div id="settings" class="page-section card" style="display: none;">
                        <!-- Settings Content will be rendered here -->
                    </div>
                    
                    <div id="projects-management" class="page-section" style="display: none;">
                        <!-- Projects Content will be rendered here -->
                    </div>
                </div>
            `;
            // Expose utility and management functions globally for HTML to use
            window.handleLogout = handleLogout;
            window.navigateAdmin = navigateAdmin;
            window.saveSettings = saveSettings;
            window.addProject = addProject;
            window.deleteProject = deleteProject;
            window.uploadHeroImage = uploadHeroImage;
            window.renderSettingsPage = renderSettingsPage; 
            window.renderProjectsPage = renderProjectsPage; 
            
            // Set initial view and load dashboard data
            navigateAdmin('dashboard'); 
        }
        
        function renderSettingsPage() {
            const settingsHtml = `
                <div class="card">
                    <h3>إعدادات الأسعار والصورة الرئيسية</h3>
                    <div class="form-group">
                        <label for="setting-price">سعر المتر المربع القياسي (دينار)</label>
                        <input type="number" id="setting-price" value="${siteSettings.pricePerMeter || 23000}">
                    </div>

                    <div class="form-group">
                        <label for="setting-hero-url">رابط صورة البانر الرئيسية (Hero Image URL)</label>
                        <input type="text" id="setting-hero-url" value="${siteSettings.heroImageUrl || ''}" placeholder="أو ارفع ملف جديد أدناه">
                        <img id="hero-preview" src="${siteSettings.heroImageUrl || 'https://placehold.co/200x100?text=No+Image'}" style="max-width: 100%; height: auto; margin-top: 1rem; border-radius: var(--border-radius); display: block;">
                    </div>
                    
                    <div class="form-group">
                        <label for="setting-hero-file">رفع صورة جديدة للبانر (سيتم تحديث الرابط أعلاه)</label>
                        <input type="file" id="setting-hero-file" accept="image/*">
                        <button class="btn btn-gold" style="margin-top: 1rem; width: 100%;" onclick="uploadHeroImage(document.getElementById('setting-hero-file').files[0])">رفع الصورة وحفظ الرابط</button>
                    </div>

                    <button class="btn" style="width: 100%; margin-top: 1rem;" onclick="saveSettings()">حفظ الإعدادات</button>
                    <p style="margin-top: 1rem; font-size: 0.9rem;">آخر تحديث: <span style="font-weight: 600;">${siteSettings.lastUpdated ? new Date(siteSettings.lastUpdated).toLocaleString() : '---'}</span></p>
                </div>
            `;
            const settingsElement = document.getElementById('settings');
            if (settingsElement) {
                settingsElement.innerHTML = settingsHtml;
            }
        }

        function renderProjectsPage() {
            const projectCategories = ['أسقف', 'جدران', 'شاشات', 'ديكور فاخر', 'شغل مطاعم'];
            
            const addProjectCard = `
                <div class="card">
                    <h3>إضافة مشروع جديد</h3>
                    <form id="project-form" onsubmit="event.preventDefault(); addProject();">
                        <div class="form-group">
                            <label for="project-title">عنوان المشروع</label>
                            <input type="text" id="project-title" placeholder="مثل: سقف صالة رئيسية">
                        </div>
                        <div class="form-group">
                            <label for="project-category">الفئة</label>
                            <select id="project-category">
                                ${projectCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="project-description">وصف مختصر</label>
                            <input type="text" id="project-description" placeholder="الوصف يظهر في واجهة الموقع">
                        </div>
                        <div class="form-group">
                            <label for="project-image">صورة المشروع</label>
                            <input type="file" id="project-image" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn btn-gold" style="width: 100%;">إضافة المشروع</button>
                    </form>
                </div>
            `;

            const projectList = projectsData.map(p => `
                <div class="project-list-item">
                    <div style="display: flex; align-items: center;">
                        <img src="${p.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-left: 1rem;">
                        <div>
                            <strong>${p.title}</strong>
                            <p style="font-size: 0.9rem; color: #666;">الفئة: ${p.category}</p>
                        </div>
                    </div>
                    <div class="project-actions">
                        <button class="btn" style="background: #F44336; padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="deleteProject('${p.id}')">حذف</button>
                    </div>
                </div>
            `).join('');

            const projectsManagementElement = document.getElementById('projects-management');
            if (projectsManagementElement) {
                projectsManagementElement.innerHTML = `
                    ${addProjectCard}
                    
                    <div class="card">
                        <h3>قائمة المشاريع الحالية (${projectsData.length})</h3>
                        <div id="project-list">
                            ${projectsData.length > 0 ? projectList : '<p style="text-align: center;">لا توجد مشاريع مضافة حالياً.</p>'}
                        </div>
                    </div>
                `;
            }
            
            // Update dashboard project count
            const totalProjectsSpan = document.getElementById('total-projects');
            if(totalProjectsSpan) totalProjectsSpan.textContent = projectsData.length;
        }

        // --- UTILITIES ---
        let loadingTimeout;
        function setLoading(isLoading) {
            if(isLoading) {
                appContainer.style.opacity = 0.5;
                loadingTimeout = setTimeout(() => {
                    appContainer.style.pointerEvents = 'none';
                }, 100);
            } else {
                clearTimeout(loadingTimeout);
                appContainer.style.opacity = 1;
                appContainer.style.pointerEvents = 'auto';
            }
        }
        
        function alertUser(message, type) {
            const color = type === 'success' ? '#28A745' : '#DC3545';
            const alertBox = document.createElement('div');
            alertBox.style.cssText = `
                position: fixed;
                top: 1rem;
                left: 50%;
                transform: translateX(-50%);
                padding: 1rem 2rem;
                background-color: ${color};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 3000;
                font-family: 'Cairo', sans-serif;
                text-align: center;
            `;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.remove();
            }, 3000);
        }

    </script>
</body>
</html>